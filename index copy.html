<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Quiz Maker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333333;
        }
        .quiz-question {
            margin-bottom: 20px;
            border: 1px solid #e1e1e1;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .options {
            list-style-type: none;
            padding: 0;
        }
        .options li {
            margin-bottom: 10px;
        }
        .options input {
            margin-right: 10px;
        }
        #loading {
            display: none;
            margin-top: 20px;
        }
        #loading-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 5px;
            height: 20px;
            overflow: hidden;
            position: relative;
            display: none; /* Initially hidden */
        }
        #loading-progress {
            width: 0%;
            height: 100%;
            background-color: #007bff;
            transition: width 0.2s ease;
        }
        #score-output {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-center mb-4">AI-Powered Quiz Maker</h1>
    <p id="output-field">Enter a topic or upload a document to generate quiz questions:</p>
    
    <div class="mb-4">
        <label for="topic-input" class="form-label">Enter Topic:</label>
        <textarea id="topic-input" class="form-control" placeholder="Enter topic..." aria-label="Topic input" rows="4" cols="50" required></textarea>
    </div>
    
    <div class="mb-4">
        <label for="question-input" class="form-label">Input Questions (Max 100):</label>
        <input type="number" id="question-input" class="form-control" placeholder="Enter your range here..." min="1" max="100" required oninput="this.value = Math.max(1, Math.min(100, this.value));">
        <small class="form-text text-muted">You can enter a number between 1 and 100.</small>
    </div>
    
  <!-- Add a loading screen -->
<div id="loading-screen" style="display:none; text-align: center; margin-top: 20px;">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p>Scanning Text...</p>
</div>

<!-- File input and buttons -->
<div class="input-group mb-4">
    <input type="file" id="file-input" accept=".txt,.pdf" style="display:none;">
    <button id="file-btn" class="btn btn-secondary">Upload File</button>
    <button id="generate-quiz-btn" class="btn btn-primary">Generate Quiz</button>
</div>


    <div id="loading" style="display: none;">Generating quiz, please wait...</div>
    <div id="loading-bar">
        <div id="loading-progress"></div>
    </div>
    <div id="quiz-output"></div>
    <button id="submit-quiz-btn" class="btn btn-success mt-3" style="display: none;">Submit Answers</button>
    <div id="score-output"></div>
</div>

<script type="importmap">
{
    "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
}
</script>

<script type="module">
    import { GoogleGenerativeAI, HarmBlockThreshold, HarmCategory } from "@google/generative-ai";

    const API_KEY = 'AIzaSyCW-qGbbyLBerWcUMUu-mAa7-NnSfSrFpc'; 
    const genAI = new GoogleGenerativeAI(API_KEY);
    let chat;

    const safetySettings = [
        {
            category: HarmCategory.HARM_CATEGORY_HARASSMENT,
            threshold: HarmBlockThreshold.BLOCK_ONLY_HIGH,
        },
    ];

    let questions = []; // Store questions and answers

    async function initializeChat(topic, questionRange) {
        chat = await genAI.getGenerativeModel({ model: "gemini-1.5-pro", safetySettings }).startChat({
            history: [{ role: "user", parts: [{ text: `You are a knowledgeable and engaging quiz master. Generate a ${questionRange} Question multiple-choice quiz on the topic: ${topic}. Follow this format strictly: Question Title: [Insert the question here] Options: [Option A, Option B, Option C, Option D] Correct Answer: [Correct answer]` }] }],
            generationConfig: {  
                temperature: 1,
                topP: 0.95,
                topK: 64,
                maxOutputTokens: 8192,
                responseMimeType: "text/plain",
            },
        });
    }

    async function generateQuiz(topic, questionRange) {
        if (!chat) {
            await initializeChat(topic, questionRange);
        }

        const model = chat;

        try {
            // Show loading bar
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading-bar').style.display = 'block'; // Show loading bar
            const loadingProgress = document.getElementById('loading-progress');
            loadingProgress.style.width = '0%'; // Reset progress

            // Simulate loading progress (this is just for visual effect)
            const loadingInterval = setInterval(() => {
                const currentWidth = parseInt(loadingProgress.style.width);
                if (currentWidth < 100) {
                    loadingProgress.style.width = (currentWidth + 10) + '%'; // Increase progress
                }
            }, 200); // Adjust speed as needed

            console.log("Generating quiz for topic:", topic); // Debugging output

            const result = await model.sendMessage(`You are a knowledgeable and engaging quiz master. Generate a ${questionRange} Question multiple-choice quiz on the topic: ${topic}. Follow this format strictly: Question Title: [Insert the question here] Options: [Option A, Option B, Option C, Option D] Correct Answer: [Correct answer]`);
            const response = await result.response;

            console.log("Response received:", response); // Debugging output

            // Clear the loading interval
            clearInterval(loadingInterval);
            loadingProgress.style.width = '100%'; // Complete progress

            if (response) {
                const quizText = await response.text();
                console.log("Quiz text received:", quizText); // Debugging output
                renderQuiz(quizText);
            } else {
                displayQuiz("This content is not safe for display based on current settings.");
            }
        } catch (error) {
            console.error("Error generating quiz:", error);
            displayQuiz("An error occurred while generating the quiz.");
        } finally {
            // Hide loading indicators
            document.getElementById('loading').style.display = 'none';
            document.getElementById('loading-bar').style.display = 'none'; // Hide loading bar
        }
    }

    function renderQuiz(quizText) {
        // Parse the quizText into a structured format
        questions = []; // Clear previous questions
        const inputLines = quizText.split("\n");

        let currentQuestion = null;

        inputLines.forEach(line => {
            if (line.startsWith("Question Title:")) {
                if (currentQuestion) {
                    questions.push(currentQuestion); // Save the last question
                }
                currentQuestion = { title: line.replace("Question Title: ", ""), options: [], correctAnswer: "" };
            } else if (line.startsWith("Options:")) {
                currentQuestion.options = line.replace("Options: ", "").split(", ");
            } else if (line.startsWith("Correct Answer:")) {
                currentQuestion.correctAnswer = line.replace("Correct Answer: ", "");
            }
        });

        if (currentQuestion) {
            questions.push(currentQuestion); // Push the last question
        }

        // Render the quiz to the page
        const quizContainer = document.getElementById("quiz-output");
        quizContainer.innerHTML = ""; // Clear any previous quiz

        questions.forEach((question, questionIndex) => {
            const questionDiv = document.createElement("div");
            questionDiv.className = "quiz-question";

            const questionTitle = document.createElement("div");
            questionTitle.className = "question fw-bold";
            questionTitle.textContent = `${questionIndex + 1}. ${question.title}`;
            questionDiv.appendChild(questionTitle);

            const optionsList = document.createElement("ul");
            optionsList.className = "options";
            question.options.forEach((option, optionIndex) => {
                const optionItem = document.createElement("li");
                const optionInput = document.createElement("input");
                optionInput.type = "radio";
                optionInput.name = `question-${questionIndex}`;
                optionInput.value = option;

                optionItem.appendChild(optionInput);
                optionItem.appendChild(document.createTextNode(option));
                optionsList.appendChild(optionItem);
            });

            questionDiv.appendChild(optionsList);
            quizContainer.appendChild(questionDiv);
        });

        document.getElementById("submit-quiz-btn").style.display = "block"; // Show submit button
    }

 
    document.getElementById('file-btn').addEventListener('click', () => {
    document.getElementById('file-input').click(); // Trigger file input dialog
});

document.getElementById('file-input').addEventListener('change', async () => {
    const fileInput = document.getElementById('file-input');
    const file = fileInput.files[0];

    if (!file) {
        alert("Please select a file.");
        return;
    }

    const apiKey = "K87789744488957"; // Your OCR.space API Key
    const formData = new FormData();
    formData.append("apikey", apiKey);
    formData.append("file", file);

    const loadingIndicator = document.getElementById('loading-screen');
    loadingIndicator.style.display = 'block'; // Show loading indicator

    try {
        const response = await fetch("https://api.ocr.space/parse/image", {
            method: "POST",
            body: formData
        });

        const data = await response.json();
        loadingIndicator.style.display = 'none'; // Hide loading indicator

        if (data.IsErroredOnProcessing) {
            alert("Error: " + data.ErrorMessage);
        } else {
            // Extract relevant text from the response
            const parsedText = data.ParsedResults[0].ParsedText;

            // Set the parsed text into the topic input field
            document.getElementById('topic-input').value = parsedText;
        }
    } catch (error) {
        loadingIndicator.style.display = 'none'; // Hide loading indicator
        console.error("Error:", error);
        alert("An error occurred: " + error.message);
    }
});

document.getElementById('file-input').addEventListener('change', handleFileUpload);

    document.getElementById("file-btn").addEventListener("click", () => {
        document.getElementById("file-input").click();
    });

    document.getElementById("file-input").addEventListener("change", handleFileUpload);

    document.getElementById("generate-quiz-btn").addEventListener("click", () => {
        const topic = document.getElementById("topic-input").value;
        const questionRange = document.getElementById("question-input").value;

        if (topic && questionRange) {
            generateQuiz(topic, questionRange);
        } else {
            alert("Please enter a topic and the number of questions.");
        }
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
</body>
</html>
